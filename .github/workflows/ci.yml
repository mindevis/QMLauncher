name: CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ dev ]

permissions:
  contents: read

jobs:
  # –ü–æ–ª–Ω—ã–π CI –¥–ª—è –≤–µ—Ç–∫–∏ main: —Ç–µ—Å—Ç—ã + –ª–∏–Ω—Ç–∏–Ω–≥ + –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–º–∏—Ç–æ–≤ + –ø—Ä–æ–≤–µ—Ä–∫–∞ coverage
  full-ci:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v6
        with:
          go-version: '1.25'

      - name: Setup Node.js for commitlint
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install commitlint
        run: |
          npm install -g @commitlint/cli @commitlint/config-conventional

      - name: Check branch protection
        if: github.event_name == 'push'
        run: |
          echo "üîí Checking if push to main comes from dev merge..."
          # Get the commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if echo "$COMMIT_MSG" | grep -q "^Merge"; then
            echo "‚úÖ Push to main is a merge commit - allowed"
          else
            echo "‚ùå Direct push to main is not allowed. Only merges from dev are permitted."
            exit 1
          fi

      - name: Run commitlint
        run: |
          echo "Validating commit messages..."
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose
          else
            echo "Validating last commit..."
            npx commitlint --last --verbose
          fi

      - name: Run tests
        run: go test ./... -v -race -coverprofile=coverage.out

      - name: Run linting
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --timeout=5m

      - name: Check test coverage
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
          echo "Test coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "‚ùå Test coverage is below 80%: $COVERAGE%"
            exit 1
          fi

  # –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã –¥–ª—è –≤–µ—Ç–∫–∏ dev
  dev-tests:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v6
        with:
          go-version: '1.25'

      - name: Run tests
        run: go test ./... -v -race